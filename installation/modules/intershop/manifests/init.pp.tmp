class intershop::user {

  Exec { path => '/bin:/usr/sbin' }
  define intershop::set_password($user=$title) {
    $password='$6$ES5FnGUo$oPHLgVH9vT3uZAF0buVMaX4hhoEfQZZi.tswCa/Kf5oSwwwU0ksltf4W/xmRftVDEqw8seey1uydPHgzwCtHW1'
    exec {
      "usermod -p '${password}' ${user}":
        onlyif => "egrep -q '^${user}:!:' /etc/shadow",
               require => User[$user];
    }
  }

  User {
      ensure => present,
      require => Group["isgrp1"],
      shell => "/bin/bash",
      home => "/opt/intershop/eserver1",
      groups => ["isgrp1"],
  }

  user {
    "isas1":
      uid => 3200;
    "iswa1":
      uid => 3201;
  }

  
  group {
    "isgrp1":
      gid => 3200,
      ensure => present;
  }

  intershop::set_password{ 'isas1': }
  intershop::set_password{ 'iswa1': }

}
class intershop::base {

  $apt_get = ["libssl0.9.8","libasound2","libxi6","libxrender1","libxtst6","libc6-i386"]
  package {
    $apt_get:
    require => Exec["apt-update"],
    ensure => installed;
  }

  $intershop_version="7.2.1.0-137"
  $package_dir="/tmp/vagrant-puppet/modules-0/intershop/files/deb"

INTERSHOP_PACKAGES

  $dpkg_force_overwrite = "/usr/bin/dpkg -i --force-confdef --force-overwrite"

  #exec can not handle arrays, fixed in puppet 3.2.0
  #$packages_with_duplicates = [
  #  "${dpkg_force_overwrite} ${package_dir}/intershop-es1-sfs-bc-marketing-share_${intershop_version}_amd64.deb",
  #  "${dpkg_force_overwrite} ${package_dir}/intershop-es1-sfs-orm-share_${intershop_version}_amd64.deb",
  #  "${dpkg_force_overwrite} ${package_dir}/intershop-es1-sfs-core-share_${intershop_version}_amd64.deb",
  #]
#
#  exec{
#     "install_packages_with_duplicates_1":
#       require => Package["intershop-base"],
#       unless => "/usr/bin/test -f /var/opt/intershop/eserver1/log/postinstall.log",
#       command => "${dpkg_force_overwrite} ${package_dir}/intershop-es1-sfs-bc-marketing-share_${intershop_version}_amd64.deb";
#  }
#  exec{
#     "install_packages_with_duplicates_2":
#       require => Exec["install_packages_with_duplicates_1"],
#       unless => "/usr/bin/test -f /var/opt/intershop/eserver1/log/postinstall.log",
#       command => "${dpkg_force_overwrite} ${package_dir}/intershop-es1-sfs-orm-share_${intershop_version}_amd64.deb";
#  }
#  exec{
#     "install_packages_with_duplicates_3":
#       require => Exec["install_packages_with_duplicates_2"],
#       unless => "/usr/bin/test -f /var/opt/intershop/eserver1/log/postinstall.log",
#       command => "${dpkg_force_overwrite} ${package_dir}/intershop-es1-sfs-core-share_${intershop_version}_amd64.deb";
#  }

}

class intershop::optional {

  $intershop_version="7.2.1.0-137"
  $package_dir="/tmp/vagrant-puppet/modules-0/intershop/files/deb/optional"

INTERSHOP_OPTIONAL_PACKAGES

}

class intershop::postinstall {  
  $is_home="/eserver1"
  $is_share="${is_home}/share"
  $is_etc="/etc/opt/intershop/eserver1"

  File {
     mode => 0660,
     owner => isas1,
     group => isgrp1,
     require => Class['intershop::base']
  }

  file {
    "${is_share}/system/cartridges/tools/release/lib/ojdbc6.jar":
      source => "puppet:///modules/intershop/ojdbc6.jar";
    "${is_share}/system/cartridges/tools/release/lib/ucp.jar":
      source => "puppet:///modules/intershop/ucp.jar";
    "${is_share}/system/license":
      ensure => directory;
    "${is_share}/system/license/license.xml":
      require => File["${is_share}/system/license"],
      source => "puppet:///modules/intershop/license.xml";
    "${is_etc}/postinstall.properties.vm":
      source => "puppet:///modules/intershop/postinstall.properties";
    "${is_share}/system/cartridges/cartridgelist.properties":
      source => "puppet:///modules/intershop/cartridgelist.properties";
    "${is_share}/sites":
      ensure => directory;
    "${is_share}/system/config/servers":
      ensure => directory;
    "${is_share}/system/config/servers/127.0.1.1":
      require => File["${is_share}/system/config/servers"],
      ensure => directory;
    "${is_share}/system/config/servers/127.0.1.1/ES1":
      require => File["${is_share}/system/config/servers/127.0.1.1"],
      ensure => directory;
  }

  exec{
    "postinstall.pl":
      require => [Class['intershop::base'],File["${is_etc}/postinstall.properties.vm"],File["${is_share}/system/config/servers/127.0.1.1/ES1"]],
      command => "${is_home}/bin/postinstall.pl ${is_etc}/postinstall.properties.vm",
      #creates => "/var/opt/intershop/eserver1/log/postinstall.log",
  }

  exec{
    "dbinit":
      require => Exec["postinstall.pl"],
      command => "${is_home}/bin/dbinit.sh -classic",
      creates => "${is_share}/system/log/dbinit-sql",
      timeout => 2400;
  }

  exec{
    "ant precompile":
      require => [Exec["dbinit"], File["${is_share}/sites"]],
      command => "${is_home}/tools/ant/bin/ant -f ${is_home}/tools/misc/build.xml precompile",
      creates => "${is_share}/system/cartridges/xcs/release/pagecompile",
      timeout => 1200;
  }

  exec{
    "rights":
      require => Exec["ant precompile"],
      command => "/vagrant/modules/intershop/files/rights.sh",
      unless => "/usr/bin/test $(stat -c %a src) -eq 770",
  }

}
